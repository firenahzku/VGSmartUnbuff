VGSmartUnbuff_PriorityList = {
	-- Active buffs that cannot be removed
	["Trueshot Aura"] = {
		["Interface\\Icons\\Ability_TrueShot"] = 0,
	},
	["Aspect of the Pack"] = {
		["Interface\\Icons\\Ability_Mount_WhiteTiger"] = 1,
	},
	["Aspect of the Wild"] = {
		["Interface\\Icons\\Spell_Nature_ProtectionformNature"] = 2,
	},
	["Blood Pact"] = {
		["Interface\\Icons\\Spell_Shadow_BloodBoil"] = 3,
	},
	["Argent Dawn Commission"] = {
		["Interface\\Icons\\INV_Jewelry_Talisman_07"] = 4,
	},
	-- Totems, also cannot be removed
	["Grace of Air"] = {
		["Interface\\Icons\\Spell_Nature_InvisibilityTotem"] = 5,
	},
	["Fire Resistance"] = {
		["Interface\\Icons\\Spell_FireResistanceTotem_01"] = 6,
	},
	["Strength of Earth"] = {
		["Interface\\Icons\\Spell_Nature_EarthBindTotem"] = 7,
	},
	["Frost Resistance"] = {
		["Interface\\Icons\\Spell_FrostResistanceTotem_01"] = 8,
	},
	["Grounding Totem Effect"] = {
		["Interface\\Icons\\Spell_Nature_GroundingTotem"] = 9,
	},
	["Nature Resistance"] = {
		["Interface\\Icons\\Spell_Nature_NatureResistanceTotem"] = 10,
	},
	["Stoneskin"] = {
		["Interface\\Icons\\Spell_Nature_StoneSkinTotem"] = 11,
	},
	["Windwall"] = {
		["Interface\\Icons\\Spell_Nature_EarthBind"] = 12,
	},
	["Healing Stream"] = {
		["Interface\\Icons\\INV_Spear_04"] = 13,
	},
	["Mana Spring"] = {
		["Interface\\Icons\\Spell_Nature_ManaRegenTotem"] = 14,
	},
	["Tranquil Air"] = {
		["Interface\\Icons\\Spell_Nature_Brilliance"] = 15,
	},
	["Mana Tide"] = {
		["Interface\\Icons\\Spell_Frost_SummonWaterElemental"] = 16,
	},
	-- World buffs, don't want to lose those ever
	["Rallying Cry of the Dragonslayer"] = {
		["Interface\\Icons\\INV_Misc_Head_Dragon_01"] = 20,
	},
	["Warchief's Blessing"] = {
		["Interface\\Icons\\Spell_Arcane_TeleportOrgrimmar"] = 21,
	},
	["Spirit of Zandalar"] = {
		["Interface\\Icons\\Ability_Creature_Poison_05"] = 22,
	},
	["Sayge's Dark Fortune of Damage"] = {
		["Interface\\Icons\\INV_Misc_Orb_02"] = 23,
	},
	["Celebrate Good Times!"] = {
        ["Interface\\Icons\\Spell_Nature_Strength"] = 23.5,
    },
    ["Elune's Blessing"] = {
		["Interface\\Icons\\INV_Misc_Gem_Pearl_02"] = 23.6,
	},
	["Traces of Silithyst"] = {
		["Interface\\Icons\\Spell_Nature_TimeStop"] = 23.7,
	},
	["Songflower Serenade"] = {
		["Interface\\Icons\\Spell_Holy_MindVision"] = 24,
	},
	["Sayge's Dark Fortune of Stamina"] = {
		["Interface\\Icons\\INV_Misc_Orb_02"] = 25,
	},
	["Fengus' Ferocity"] = {
		["Interface\\Icons\\Spell_Nature_UndyingStrength"] = 26,
	},
	["Mol'dar's Moxie"] = {
		["Interface\\Icons\\Spell_Nature_MassTeleport"] = 27,
	},
	["Resist Fire"] = {
		["Interface\\Icons\\Spell_Fire_FireArmor"] = 28,
	},
	-- Consumables that we never want to lose
	["Flask of the Titans"] = {
		["Interface\\Icons\\INV_Potion_62"] = 30,
	},
	["Elixir of the Mongoose"] = {
		["Interface\\Icons\\INV_Potion_32"] = 31,
	},
	["Swiftness of Zanza"] = {
		["Interface\\Icons\\INV_Potion_31"] = 32,
	},
	["Sheen of Zanza"] = {
		["Interface\\Icons\\INV_Potion_29"] = 33,
	},
	["Spirit of Zanza"] = {
		["Interface\\Icons\\INV_Potion_30"] = 34,
	},
	-- Cooldowns we don't want to lose because we only use them when we have to
	["Shield Wall"] = {
		["Interface\\Icons\\Ability_Warrior_ShieldWall"] = 40,
	},
	["Recklessness"] = {
		["Interface\\Icons\\Ability_CriticalStrike"] = 41,
	},
	["Retaliation"] = {
		["Interface\\Icons\\Ability_Warrior_Challange"] = 42,
	},
	["Last Stand"] = {
		["Interface\\Icons\\Spell_Holy_AshesToAshes"] = 43,
	},
	["Gift of Life"] = {
		["Interface\\Icons\\INV_Misc_Gem_Pearl_05"] = 44,
	},
	["Berserker Rage"] = {
		["Interface\\Icons\\Spell_Nature_AncestralGuardian"] = 45,
	},
	["Shield Block"] = {
		["Interface\\Icons\\Ability_Defend"] = 46,
	},
	-- High priority potions
	["Greater Stoneshield"] = {
		["Interface\\Icons\\INV_Potion_69"] = 50,
	},
	["Free Action"] = {
		["Interface\\Icons\\INV_Potion_04"] = 51,
	},
	["Living Free Action"] = {
		["Interface\\Icons\\INV_Potion_07"] = 52,
	},
	["Invulnerability"] = {
		["Interface\\Icons\\Spell_Holy_DivineIntervention"] = 53,
	},
	["Arcane Protection"] = {
		["Interface\\Icons\\Spell_Holy_PrayerOfHealing02"] = 54,
	},
	["Fire Protection"] = {
		["Interface\\Icons\\Spell_Fire_FireArmor"] = 55,
	},
	["Frost Protection"] = {
		["Interface\\Icons\\Spell_Frost_FrostArmor02"] = 56,
	},
	["Nature Protection"] = {
		["Interface\\Icons\\Spell_Nature_SpiritArmor"] = 57,
	},
	["Shadow Protection"] = {
		["Interface\\Icons\\Spell_Shadow_RagingScream"] = 58,
	},
	["The Power of Friendship"] = {
		["Interface\\Icons\\INV_Jewelry_Ring_03"] = 59,
	},
	-- High-threat temporary buffs
	["Enrage"] = {
		["Interface\\Icons\\Spell_Shadow_UnholyFrenzy"] = 60,
	},
	["Flurry"] = {
		["Interface\\Icons\\Ability_GhoulFrenzy"] = 61,
	},
	["Eskhandar's Rage"] = {
		["Interface\\Icons\\INV_Misc_MonsterClaw_03"] = 62,
	},
	["Haste"] = {
		["Interface\\Icons\\Spell_Nature_Invisibilty"] = 63,
	},
	["Untamed Fury"] = {
		["Interface\\Icons\\Spell_Nature_BloodLust"] = 63.5,
	},
	["Berserking"] = {
		["Interface\\Icons\\Racial_Troll_Berserk"] = 64,
	},
	["Blood Fury"] = {
		["Interface\\Icons\\Racial_Orc_BerserkerStrength"] = 64.5,
	},
	-- Threat trinkets
	["Kiss of the Spider"] = {
		["Interface\\Icons\\INV_Trinket_Naxxramas04"] = 65,
	},
	["Slayer's Crest"] = {
		["Interface\\Icons\\INV_Trinket_Naxxramas03"] = 66,
	},
	["Jom Gabbar"] = {
		["Interface\\Icons\\Ability_Poisons"] = 67,
	},
	["Badge of the Swarmguard"] = {
		["Interface\\Icons\\INV_Misc_AhnQirajTrinket_04"] = 68,
	},
	["Insight of the Qiraji"] = {
		["Interface\\Icons\\INV_QirajIdol_Death"] = 69,
	},
	["Earthstrike"] = {
		["Interface\\Icons\\Spell_Nature_AbolishMagic"] = 70,
	},
	["Diamond Flask"] = {
		["Interface\\Icons\\INV_Drink_01"] = 71,
	},
	["Mark of the Chosen Effect"] = {
		["Interface\\Icons\\INV_Jewelry_Talisman_08"] = 72,
	},
	-- Important survival temporary buffs
	["Ancestral Fortitude"] = {
		["Interface\\Icons\\Spell_Nature_UndyingStrength"] = 80,
	},
	["Inspiration"] = {
		["Interface\\Icons\\INV_Shield_06"] = 81,
	},
	["Power Word: Shield"] = {
		["Interface\\Icons\\Spell_Holy_PowerWordShield"] = 82,
	},
	["Healing Way"] = {
		["Interface\\Icons\\Spell_Nature_HealingWay"] = 83,
	},
	["Rejuvenation"] = {
		["Interface\\Icons\\Spell_Nature_Rejuvenation"] = 84,
	},
	["Regrowth"] = {
		["Interface\\Icons\\Spell_Nature_ResistNature"] = 85,
	},
	-- Rest of the buffs
	["Battle Shout"] = {
		["Interface\\Icons\\Ability_Warrior_BattleShout"] = 91,
	},
	["Mighty Rage"] = {
		["Interface\\Icons\\Ability_Warrior_InnerRage"] = 91.5,
	},
	["Rage of Ages"] = {
		["Interface\\Icons\\Spell_Nature_Strength"] = 92,
	},
	["Orgrimmar Gift of Friendship"] = {
		["Interface\\Icons\\INV_Misc_Gift_01"] = 92.5,
	},
	["Strike of the Scorpok"] = {
		["Interface\\Icons\\Spell_Nature_ForceOfNature"] = 93,
	},
	["Thunder Bluff Gift of Friendship"] = {
		["Interface\\Icons\\INV_Misc_Gift_05"] = 93.5,
	},
	["Spirit of Boar"] = {
		["Interface\\Icons\\Spell_Nature_Purge"] = 94,
	},
	["Prayer of Fortitude"] = {
		["Interface\\Icons\\Spell_Holy_PrayerOfFortitude"] = 95,
	},
	["Power Word: Fortitude"] = {
		["Interface\\Icons\\Spell_Holy_WordFortitude"] = 95.1,
	},
	["Renew"] = {
		["Interface\\Icons\\Spell_Holy_Renew"] = 96,
	},
	["Greater Heal"] = {
		["Interface\\Icons\\Spell_Holy_Renew"] = 97,
	},
	["Holy Strength"] = {
		["Interface\\Icons\\Spell_Holy_BlessingOfStrength"] = 98,
	},
	["Battle Squawk"] = {
		["Interface\\Icons\\INV_Misc_Birdbeck_01"] = 99,
	},
	["Dark Desire"] = {
		["Interface\\Icons\\INV_ValentinesChocolate04"] = 99.5,
	},
	["Buttermilk Delight"] = {
		["Interface\\Icons\\INV_ValentinesChocolate01"] = 99.6,
	},
	["Juju Power"] = {
		["Interface\\Icons\\INV_Misc_MonsterScales_11"] = 100,
	},
	["Gift of the Wild"] = {
		["Interface\\Icons\\Spell_Nature_Regeneration"] = 101,
	},
	["Mark of the Wild"] = {
		["Interface\\Icons\\Spell_Nature_Regeneration"] = 101.1,
	},
	["Juju Might"] = {
		["Interface\\Icons\\INV_Misc_MonsterScales_07"] = 102,
	},
	["Greater Armor"] = {
		["Interface\\Icons\\INV_Potion_86"] = 103,
	},
	["Well Fed"] = {
		["Interface\\Icons\\Spell_Misc_Food"] = 104,
	},
	["Rumsey Rum Black Label"] = {
		["Interface\\Icons\\INV_Drink_04"] = 105,
	},
	["Health II"] = {
		["Interface\\Icons\\INV_Potion_44"] = 106,
	},
	["Gordok Green Grog"] = {
		["Interface\\Icons\\INV_Drink_03"] = 107,
	},
	["Juju Ember"] = {
		["Interface\\Icons\\INV_Misc_MonsterScales_15"] = 108,
	},
	["Juju Chill"] = {
		["Interface\\Icons\\INV_Misc_MonsterScales_09"] = 109,
	},
	["Juju Flurry"] = {
		["Interface\\Icons\\INV_Misc_MonsterScales_17"] = 110,
	},
	["Juju Escape"] = {
		["Interface\\Icons\\INV_Misc_MonsterScales_17"] = 111,
	},
}

VGSmartUnbuffFrame = CreateFrame("Frame", nil, UIParent)
VGSmartUnbuffFrame:RegisterEvent("PLAYER_AURAS_CHANGED")

CreateFrame("GameTooltip", "VGSmartUnbuffToolTip", nil, "GameTooltipTemplate")
VGSmartUnbuffToolTip:SetOwner(WorldFrame, "ANCHOR_NONE")

VGSmartUnbuff_buffsOnPlayer = nil

function scanBuffs()
	VGSmartUnbuff_buffsOnPlayer = {}
	local i = 0
	while GetPlayerBuff(i, "HELPFUL") >= 0 do
		local buffIndex, untilCancelled = GetPlayerBuff(i, "HELPFUL")
		local texture = GetPlayerBuffTexture(buffIndex)
		-- Print(texture)
		if (texture ~= nil) then
			VGSmartUnbuffToolTip:ClearLines()
			VGSmartUnbuffToolTip:SetPlayerBuff(buffIndex)
			if (VGSmartUnbuffToolTipTextLeft1:IsShown()) then
				local auraName = VGSmartUnbuffToolTipTextLeft1:GetText()
				-- Print(buffIndex.." "..auraName)
				VGSmartUnbuff_buffsOnPlayer[buffIndex] = {texturePath = texture, aura = auraName}
			end
			i = i + 1
		end
	end
end

function removeSmallestPriorityBuff()
	if (VGSmartUnbuff_buffsOnPlayer == nil) then return end
	local numBuffs = 0
	for key, val in pairs(VGSmartUnbuff_buffsOnPlayer) do numBuffs = numBuffs + 1 end
	if (numBuffs < 30) then return end
	local maxPriorityBuffIndex = nil
	local maxPriorityValue = nil
	for buffIndex, val in pairs(VGSmartUnbuff_buffsOnPlayer) do
		-- Print("["..(val.texturePath).."]")
		local currentPriority = 100000
		if (VGSmartUnbuff_PriorityList[val.aura] ~= nil and VGSmartUnbuff_PriorityList[val.aura][val.texturePath] ~= nil) then
			-- Print("Found "..val.aura)
			currentPriority = VGSmartUnbuff_PriorityList[val.aura][val.texturePath]
		end
		if (maxPriorityBuffIndex == nil or maxPriorityValue < currentPriority) then
			maxPriorityBuffIndex = buffIndex
			maxPriorityValue = currentPriority
		end
	end
	-- Print(maxPriorityBuffIndex)
	CancelPlayerBuff(maxPriorityBuffIndex)
	DEFAULT_CHAT_FRAME:AddMessage("<VGSmartUnbuff> "..VGSmartUnbuff_buffsOnPlayer[maxPriorityBuffIndex].aura.." removed due to buff cap")
end

function VGSmartUnbuff_OnEvent()
	if (event == "PLAYER_AURAS_CHANGED") then
		scanBuffs()
		removeSmallestPriorityBuff()
	end
end

VGSmartUnbuffFrame:SetScript("OnEvent", VGSmartUnbuff_OnEvent)